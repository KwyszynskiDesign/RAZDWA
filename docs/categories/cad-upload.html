<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kalkulator Druku CAD - Wycena Wydruk√≥w</title>
<div class="cad-calc">
  <div class="cad-calc__wrapper">

    <div class="cad-calc__header">
      <h2 class="cad-calc__title">üñ®Ô∏è Kalkulator Druku CAD</h2>
      <p class="cad-calc__subtitle">Wycena wydruk√≥w wielkiformatowych - formaty A0+ do A3</p>
    </div>

    <div class="cad-calc__content">

      <!-- Upload -->
      <div class="cad-calc__upload" id="uploadZone">
        <h3>PrzeciƒÖgnij pliki tutaj</h3>
        <p>lub kliknij, aby wybraƒá</p>
        <input type="file" id="fileInput" multiple />
      </div>

      <!-- Settings -->
      <div class="cad-calc__settings">
        <div class="cad-calc__field">
          <label>DPI</label>
          <input type="number" id="dpiInput" value="300" min="72" max="600" />
        </div>

        <div class="cad-calc__toggle" id="colorToggle">
          <span>Czarno-bia≈Çe</span>
          <div class="cad-calc__switch" id="colorSwitch"></div>
          <span>Kolorowe</span>
        </div>
      </div>

      <!-- Rolls Summary -->
      <div class="cad-calc__rolls hidden" id="rollsSummary">
        <div id="rollsList"></div>
        <div id="suggestedRoll"></div>
        <div class="cad-calc__warning" id="warningAlert">
          <span id="warningCount"></span>
          <div id="warningDetails"></div>
        </div>
      </div>

      <!-- Table -->
      <div class="cad-calc__table-wrapper" id="filesTableWrapper">
        <table class="cad-calc__table">
          <thead>
            <tr>
              <th>Nazwa</th>
              <th>Rozmiar</th>
              <th>Wymiary</th>
              <th>Format</th>
              <th>Typ</th>
              <th>Sk≈Çadanie</th>
              <th>Skan</th>
              <th>Cena</th>
            </tr>
          </thead>
          <tbody id="filesTableBody"></tbody>
        </table>
      </div>

      <!-- Summary -->
      <div class="cad-calc__summary" id="summaryPanel">
        <h3>üí∞ Podsumowanie</h3>
        <div id="summaryGrid"></div>
        <button class="cad-calc__btn" id="clearBtn">Wyczy≈õƒá</button>
      </div>

      <!-- CAD Ops: sk≈Çadanie + skan wielkoformat -->
      <div class="cad-calc__ops">
        <h3>üóÇÔ∏è CAD Ops: Sk≈Çadanie / Skan wielkoformat</h3>
        <div class="cad-calc__ops-grid">
          <div class="cad-calc__ops-form">
            <h4>Sk≈Çadanie</h4>
            <div class="cad-calc__field">
              <label for="fold-format">Format:</label>
              <select id="fold-format">
                <option value="A0+">A0+</option>
                <option value="A0">A0</option>
                <option value="A1">A1</option>
                <option value="A2">A2</option>
                <option value="A3">A3</option>
                <option value="A3-poprzeczne">A3-poprzeczne</option>
              </select>
            </div>
            <div class="cad-calc__field">
              <label for="fold-qty">Ilo≈õƒá (szt):</label>
              <input type="number" id="fold-qty" value="1" min="1" />
            </div>
            <button class="cad-calc__btn" id="fold-add">Dodaj sk≈Çadanie</button>
          </div>
          <div class="cad-calc__ops-form">
            <h4>Skanowanie wielkoformatowe</h4>
            <div class="cad-calc__field">
              <label for="wf-scan-mm">D≈Çugo≈õƒá (mm):</label>
              <input type="number" id="wf-scan-mm" placeholder="np. 1100" min="1" />
            </div>
            <div class="cad-calc__field">
              <label for="wf-scan-qty">Ilo≈õƒá (szt):</label>
              <input type="number" id="wf-scan-qty" value="1" min="1" />
            </div>
            <button class="cad-calc__btn" id="wf-scan-add">Dodaj skan</button>
          </div>
        </div>
        <div class="cad-calc__ops-list hidden" id="opsList">
          <h4>Dodane us≈Çugi:</h4>
          <div id="opsListItems"></div>
          <div class="cad-calc__ops-total">
            Suma us≈Çug: <strong id="opsTotal">0.00 z≈Ç</strong>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

  <script>
    // CENNIK
    const PRICES = {
      formatowe: {
        czb: { A3: 2.50, A2: 4.00, A1: 6.00, A0: 11.00, 'A0+': 12.50 },
        kolor: { A3: 5.30, A2: 8.50, A1: 12.00, A0: 24.00, 'A0+': 26.00 }
      },
      nieformatowe: {
        czb: { 297: 3.50, 420: 4.50, 594: 5.00, 841: 9.00, 914: 10.00, 1067: 12.50 },
        kolor: { 297: 12.00, 420: 13.90, 594: 14.50, 841: 20.00, 914: 21.00, 1067: 30.00 }
      },
      skladanie: {
        formatowe: { A3: 1.00, 'A3-poprzeczne': 0.70, A2: 1.50, A1: 2.00, A0: 3.00, 'A0+': 4.00 },
        nieformatowe: 2.50 // z≈Ç/m¬≤
      },
      skanowanie: 0.08 // z≈Ç/mm
    };

    // FORMATY STANDARDOWE (mm)
    const FORMATS = {
      'A3': [297, 420],
      'A2': [420, 594],
      'A1': [594, 841],
      'A0': [841, 1189],
      'A0+': [914, 1292]
    };

    const STANDARD_WIDTHS = [297, 420, 594, 841, 914, 1067];
    const TOLERANCE = 5; // mm dla d≈Çugo≈õci

    let filesData = [];
    let isColor = false;
    let dpi = 300;

    // DOM Elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const dpiInput = document.getElementById('dpiInput');
    const colorToggle = document.getElementById('colorToggle');
    const colorSwitch = document.getElementById('colorSwitch');
    const rollsSummary = document.getElementById('rollsSummary');
    const rollsList = document.getElementById('rollsList');
    const suggestedRoll = document.getElementById('suggestedRoll');
    const warningAlert = document.getElementById('warningAlert');
    const warningCount = document.getElementById('warningCount');
    const warningDetails = document.getElementById('warningDetails');
    const filesTableWrapper = document.getElementById('filesTableWrapper');
    const filesTableBody = document.getElementById('filesTableBody');
    const summaryPanel = document.getElementById('summaryPanel');
    const summaryGrid = document.getElementById('summaryGrid');
    const clearBtn = document.getElementById('clearBtn');

    // Event Listeners
    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    colorToggle.addEventListener('click', () => {
      isColor = !isColor;
      colorSwitch.classList.toggle('active');
      if (filesData.length > 0) {
        recalculateAll();
      }
    });

    dpiInput.addEventListener('change', (e) => {
      dpi = parseInt(e.target.value) || 300;
      if (filesData.length > 0) {
        recalculateAll();
      }
    });

    clearBtn.addEventListener('click', () => {
      filesData = [];
      fileInput.value = '';
      updateDisplay();
    });

    if (warningAlert && warningDetails) warningAlert.addEventListener('click', () => {
      warningDetails.classList.toggle('expanded');
    });

    // Konwersja px ‚Üí mm
    function pxToMm(px, dpi) {
      return (px * 25.4) / dpi;
    }

    // Znajd≈∫ najbli≈ºszƒÖ standardowƒÖ szeroko≈õƒá
    function findClosestWidth(width) {
      return STANDARD_WIDTHS.reduce((prev, curr) => 
        Math.abs(curr - width) < Math.abs(prev - width) ? curr : prev
      );
    }

    // Sprawd≈∫ czy szeroko≈õƒá jest standardowa
    function isStandardWidth(width) {
      return STANDARD_WIDTHS.includes(Math.round(width));
    }

    // Wykryj format
    function detectFormat(widthMm, heightMm) {
      const w = Math.round(widthMm);
      const h = Math.round(heightMm);

      // Sprawd≈∫ orientacjƒô (zawsze mniejszy to szeroko≈õƒá)
      const [minDim, maxDim] = w < h ? [w, h] : [h, w];

      // Sprawd≈∫ czy szeroko≈õƒá jest standardowa
      if (!isStandardWidth(minDim)) {
        return {
          format: `${minDim}mm`,
          isFormatowy: false,
          isStandardWidth: false,
          widthCategory: findClosestWidth(minDim)
        };
      }

      // Znajd≈∫ format
      for (const [name, [fw, fh]] of Object.entries(FORMATS)) {
        if (minDim === fw) {
          // Sprawd≈∫ tolerancjƒô d≈Çugo≈õci
          const isWithinTolerance = Math.abs(maxDim - fh) <= TOLERANCE;
          return {
            format: name,
            isFormatowy: isWithinTolerance,
            isStandardWidth: true,
            widthCategory: fw,
            actualLength: maxDim,
            standardLength: fh
          };
        }
      }

      // Rolka 1067
      if (minDim === 1067) {
        return {
          format: '1067mm',
          isFormatowy: false,
          isStandardWidth: true,
          widthCategory: 1067
        };
      }

      return {
        format: `${minDim}√ó${maxDim}`,
        isFormatowy: false,
        isStandardWidth: true,
        widthCategory: minDim
      };
    }

    // Oblicz cenƒô wydruku
    function calculatePrintPrice(fileData) {
      const mode = isColor ? 'kolor' : 'czb';
      const { format, isFormatowy, widthCategory, actualLength } = fileData.formatInfo;

      if (isFormatowy) {
        return PRICES.formatowe[mode][format] || 0;
      } else {
        // Nieformatowy - cena za mb
        const pricePerMb = PRICES.nieformatowe[mode][widthCategory] || 0;
        const lengthMeters = fileData.heightMm / 1000;
        return pricePerMb * lengthMeters;
      }
    }

    // Oblicz cenƒô sk≈Çadania
    function calculateFoldingPrice(fileData) {
      if (!fileData.folding) return 0;

      const { format, isFormatowy } = fileData.formatInfo;

      if (isFormatowy) {
        return PRICES.skladanie.formatowe[format] || 0;
      } else {
        // Nieformatowy - za m¬≤
        const areaM2 = (fileData.widthMm / 1000) * (fileData.heightMm / 1000);
        return PRICES.skladanie.nieformatowe * areaM2;
      }
    }

    // Oblicz cenƒô skanowania
    function calculateScanPrice(fileData) {
      if (!fileData.scanning) return 0;
      const longerSide = Math.max(fileData.widthMm, fileData.heightMm);
      return PRICES.skanowanie * longerSide;
    }

    // Przetw√≥rz pliki
    async function handleFiles(files) {
      for (const file of files) {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
          img.onload = () => {
            const widthMm = pxToMm(img.width, dpi);
            const heightMm = pxToMm(img.height, dpi);
            const formatInfo = detectFormat(widthMm, heightMm);

            const fileData = {
              id: Date.now() + Math.random(),
              name: file.name,
              widthPx: img.width,
              heightPx: img.height,
              widthMm: widthMm,
              heightMm: heightMm,
              formatInfo: formatInfo,
              folding: false,
              scanning: false
            };

            filesData.push(fileData);
            updateDisplay();
          };
          img.src = e.target.result;
        };

        // Dla plik√≥w CAD symulujemy wymiary (w prawdziwej wersji u≈ºyj parsera DWG/DXF)
        if (file.name.match(/\.(dwg|dxf)$/i)) {
          const mockWidth = 2480 + Math.random() * 1000;
          const mockHeight = 1754 + Math.random() * 1000;
          const widthMm = pxToMm(mockWidth, dpi);
          const heightMm = pxToMm(mockHeight, dpi);
          const formatInfo = detectFormat(widthMm, heightMm);

          filesData.push({
            id: Date.now() + Math.random(),
            name: file.name,
            widthPx: mockWidth,
            heightPx: mockHeight,
            widthMm: widthMm,
            heightMm: heightMm,
            formatInfo: formatInfo,
            folding: false,
            scanning: false
          });
          updateDisplay();
        } else {
          reader.readAsDataURL(file);
        }
      }
    }

    // Przelicz wszystko przy zmianie ustawie≈Ñ
    function recalculateAll() {
      filesData = filesData.map(file => {
        const widthMm = pxToMm(file.widthPx, dpi);
        const heightMm = pxToMm(file.heightPx, dpi);
        const formatInfo = detectFormat(widthMm, heightMm);

        return {
          ...file,
          widthMm,
          heightMm,
          formatInfo
        };
      });
      updateDisplay();
    }

    // Aktualizuj wy≈õwietlanie
    function updateDisplay() {
      if (filesData.length === 0) {
        rollsSummary.classList.add('hidden');
        filesTableWrapper.classList.add('hidden');
        summaryPanel.classList.add('hidden');
        return;
      }

      rollsSummary.classList.remove('hidden');
      filesTableWrapper.classList.remove('hidden');
      summaryPanel.classList.remove('hidden');

      displayRollsSummary();
      displayFilesTable();
      displaySummary();
    }

    // Wy≈õwietl podsumowanie rolek
    function displayRollsSummary() {
      const rollCounts = {};
      const nonStandardFiles = [];

      filesData.forEach(file => {
        const { widthCategory, isStandardWidth } = file.formatInfo;

        if (!isStandardWidth) {
          nonStandardFiles.push(file);
        } else {
          rollCounts[widthCategory] = (rollCounts[widthCategory] || 0) + 1;
        }
      });

      // Wy≈õwietl rolki
      rollsList.innerHTML = Object.entries(rollCounts)
        .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
        .map(([width, count]) => `
          <div class="roll-item">
            <span>Rolka ${width}mm</span>
            <span class="roll-count">${count} plik${count > 1 ? 'i/√≥w' : ''}</span>
          </div>
        `).join('');

      // Sugerowana rolka
      const maxWidth = Math.max(...Object.keys(rollCounts).map(Number));
      suggestedRoll.innerHTML = `<strong>‚Üí Sugerowana rolka: ${maxWidth}mm (pokryje wszystkie standardowe pliki)</strong>`;

      // Ostrze≈ºenie o niestandardowych szeroko≈õciach
      if (nonStandardFiles.length > 0) {
        warningAlert.classList.add('show');
        warningCount.textContent = `${nonStandardFiles.length} plik${nonStandardFiles.length > 1 ? 'i/√≥w' : ''}`;
        warningDetails.innerHTML = nonStandardFiles.map(f => `
          <div>‚Ä¢ ${f.name}: ${Math.round(f.widthMm)} √ó ${Math.round(f.heightMm)}mm (niestandardowa szeroko≈õƒá)</div>
        `).join('');
      } else {
        warningAlert.classList.remove('show');
      }
    }

    // Wy≈õwietl tabelƒô plik√≥w
    function displayFilesTable() {
      filesTableBody.innerHTML = filesData.map(file => {
        const printPrice = calculatePrintPrice(file);
        const foldingPrice = calculateFoldingPrice(file);
        const scanPrice = calculateScanPrice(file);
        const totalPrice = printPrice + foldingPrice + scanPrice;

        const { format, isFormatowy, isStandardWidth } = file.formatInfo;

        let typeBadge = '';
        if (!isStandardWidth) {
          typeBadge = '<span class="badge badge-warning">‚ö†Ô∏è Niestandardowa szeroko≈õƒá</span>';
        } else if (isFormatowy) {
          typeBadge = '<span class="badge badge-formatowy">Formatowy</span>';
        } else {
          typeBadge = '<span class="badge badge-nieformatowy">Nieformatowy [MB]</span>';
        }

        return `
          <tr>
            <td><strong>${file.name}</strong></td>
            <td>${file.widthPx} √ó ${file.heightPx}</td>
            <td>${Math.round(file.widthMm)} √ó ${Math.round(file.heightMm)} mm<br>
                <small>${(file.widthMm/10).toFixed(1)} √ó ${(file.heightMm/10).toFixed(1)} cm</small></td>
            <td><strong>${format}</strong></td>
<td>${typeBadge}</td>  
            <td class="checkbox-cell">
              <input type="checkbox" ${file.folding ? 'checked' : ''} 
                     onchange="toggleFolding('${file.id}')" />
            </td>
            <td class="checkbox-cell">
              <input type="checkbox" ${file.scanning ? 'checked' : ''} 
                     onchange="toggleScanning('${file.id}')" />
            </td>
            <td><strong>${totalPrice.toFixed(2)} z≈Ç</strong></td>
          </tr>
        `;
      }).join('');
    }

    // Wy≈õwietl podsumowanie
    function displaySummary() {
      let totalPrint = 0;
      let totalFolding = 0;
      let totalScan = 0;

      filesData.forEach(file => {
        totalPrint += calculatePrintPrice(file);
        totalFolding += calculateFoldingPrice(file);
        totalScan += calculateScanPrice(file);
      });

      const total = totalPrint + totalFolding + totalScan;

      summaryGrid.innerHTML = `
        <div class="summary-item">
          <span>Wydruki (${filesData.length} plik${filesData.length > 1 ? 'i/√≥w' : ''}):</span>
          <span>${totalPrint.toFixed(2)} z≈Ç</span>
        </div>
        <div class="summary-item">
          <span>Sk≈Çadanie:</span>
          <span>${totalFolding.toFixed(2)} z≈Ç</span>
        </div>
        <div class="summary-item">
          <span>Skanowanie:</span>
          <span>${totalScan.toFixed(2)} z≈Ç</span>
        </div>
        <div class="summary-item">
          <span>RAZEM:</span>
          <span>${total.toFixed(2)} z≈Ç</span>
        </div>
      `;
    }

    // Toggle sk≈Çadanie
    window.toggleFolding = function(fileId) {
      const file = filesData.find(f => f.id == fileId);
      if (file) {
        file.folding = !file.folding;
        updateDisplay();
      }
    };

    // Toggle skanowanie
    window.toggleScanning = function(fileId) {
      const file = filesData.find(f => f.id == fileId);
      if (file) {
        file.scanning = !file.scanning;
        updateDisplay();
      }
    };

    // CAD Ops: sk≈Çadanie + skan wielkoformat
    (function() {
      const opsItems = [];
      const opsListEl = document.getElementById('opsList');
      const opsListItems = document.getElementById('opsListItems');
      const opsTotalEl = document.getElementById('opsTotal');

      function updateOpsList() {
        if (opsItems.length === 0) {
          opsListEl.classList.add('hidden');
          return;
        }
        opsListEl.classList.remove('hidden');
        opsListItems.innerHTML = opsItems.map((item, i) => `
          <div class="ops-item" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1)">
            <span>${item.label}</span>
            <span>${item.price.toFixed(2)} z≈Ç</span>
            <button data-remove-ops="${i}" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:16px;">‚úï</button>
          </div>
        `).join('');
        const total = opsItems.reduce(function(sum, item) { return sum + item.price; }, 0);
        opsTotalEl.textContent = total.toFixed(2) + ' z≈Ç';
      }

      opsListItems.addEventListener('click', function(e) {
        const btn = (e.target as HTMLElement).closest('[data-remove-ops]');
        if (btn) {
          const idx = parseInt((btn as HTMLElement).getAttribute('data-remove-ops') || '-1');
          if (idx >= 0) { opsItems.splice(idx, 1); updateOpsList(); }
        }
      });

      document.getElementById('fold-add').addEventListener('click', function() {
        const format = document.getElementById('fold-format').value;
        const qty = parseInt(document.getElementById('fold-qty').value) || 1;
        const unitPrice = PRICES.skladanie.formatowe[format] || 0;
        const price = unitPrice * qty;
        opsItems.push({ label: 'Sk≈Çadanie ' + format + ' √ó ' + qty + ' szt', price: price });
        updateOpsList();
      });

      document.getElementById('wf-scan-add').addEventListener('click', function() {
        const mm = parseFloat(document.getElementById('wf-scan-mm').value) || 0;
        const qty = parseInt(document.getElementById('wf-scan-qty').value) || 1;
        if (mm <= 0) { alert('Podaj d≈Çugo≈õƒá w mm'); return; }
        const price = PRICES.skanowanie * mm * qty;
        opsItems.push({ label: 'Skan wielkoformat ' + mm + 'mm √ó ' + qty + ' szt', price: price });
        updateOpsList();
      });
    })();
  </script>
</body>
</html>
