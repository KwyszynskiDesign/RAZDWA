<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator – Studio Raz Druku Dwa</title>
  <style>
    :root{
  --bg:#07070b;
  --txt:#ffffff;
  --muted:#cfcfe3;
  --line:rgba(255,255,255,.14);

  --accent:#1a64b9;
  --accent2:#02a6b6;
  --ok:#22c55e;
  --err:#ef4444;
}

    *{box-sizing:border-box}
   body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(900px 520px at 15% -10%, rgba(255,77,166,.30) 0%, transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(255,138,200,.18) 0%, transparent 55%),
    var(--bg);
  color:var(--txt);
}

    .wrap{max-width:1250px; margin:0 auto; padding:24px;}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:14px;}
    h1{margin:0; font-size:18px; letter-spacing:.2px;}
    .small{color:var(--muted); font-size:12px; margin:0;}

    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0 0 10px; font-size:14px; color:#dbe6ff; letter-spacing:.2px;}

    .tabs{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;}
    .tab{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .tab.active{
  border-color: rgba(255,77,166,.55);
  background: linear-gradient(180deg, rgba(255,77,166,.22), rgba(255,77,166,.10));
}

    .form{display:grid; gap:10px;}
    .row{
      display:grid;
      grid-template-columns: 190px 1fr;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    @media (max-width: 560px){ .row{grid-template-columns: 1fr; gap:6px;} }

    label{font-size:13px; color:#dbe6ff; min-width:0;}
    .control{min-width:0;}

    input[type="number"], input[type="text"], select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--txt);
      outline:none;
    }
   input[type="number"]:focus, input[type="text"]:focus, select:focus{
  border-color: rgba(255,77,166,.75);
  box-shadow: 0 0 0 3px rgba(255,77,166,.18);
}


    .hint{color:var(--muted); font-size:12px; margin-top:2px;}
    .divider{height:1px; background:var(--line); margin:12px 0;}

    .actions{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:12px;}
    button{
      padding:10px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.06);
      color: var(--txt);
      cursor:pointer;
      font-weight:800;
    }
   button.primary{
  background: linear-gradient(180deg, rgba(255,77,166,.32), rgba(255,77,166,.14));
  border-color: rgba(255,77,166,.55);
}
    button.success{
      background: linear-gradient(180deg, rgba(34,197,94,.35), rgba(34,197,94,.18));
      border-color: rgba(34,197,94,.45);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.25), rgba(239,68,68,.12));
      border-color: rgba(239,68,68,.45);
    }

    details{border:1px solid var(--line); border-radius:12px; background: rgba(0,0,0,.16); padding:10px 12px;}
    details summary{cursor:pointer; color:#dbe6ff; font-size:13px; font-weight:800;}
    pre{
      margin:10px 0 0; padding:10px; background: rgba(0,0,0,.35);
      border:1px solid var(--line); border-radius:12px; overflow:auto; max-height:220px;
    }

    .seg{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:6px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,.12);
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .chip.active{
  border-color: rgba(255,77,166,.65);
  background: linear-gradient(180deg, rgba(255,77,166,.26), rgba(255,77,166,.10));
}
    .hidden{display:none!important}

    .summary{display:grid; gap:10px;}
    .sumRow{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px;
      padding:10px 12px; background: rgba(0,0,0,.18);
      border:1px solid var(--line); border-radius:12px;
    }
    .sumRow .k{color:#dbe6ff; font-size:13px;}
    .sumRow .v{font-variant-numeric: tabular-nums; font-size:13px; font-weight:900;}
    .sumRow.total{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.30);}
    .sumRow.total .v{font-size:18px;}
    .pill{color:var(--muted); font-size:12px;}

    .basket{display:grid; gap:10px;}
    .basketList{border:1px solid var(--line); border-radius:12px; overflow:hidden;}
    .basketItem{
      display:grid; grid-template-columns: 1fr auto;
      gap:10px; padding:10px 12px;
      background: rgba(0,0,0,.18);
      border-top:1px solid var(--line);
      align-items:center;
    }
    .basketItem:first-child{border-top:0;}
    .basketTitle{font-size:13px; color:#dbe6ff;}
    .basketMeta{font-size:12px; color:var(--muted); margin-top:2px;}
    .basketPrice{font-variant-numeric: tabular-nums; font-weight:950;}
    .iconBtn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color:var(--txt);
      font-weight:950;
    }

    .status{color:var(--muted); font-size:12px;}
    .status.err{color:#ffb4b4;}
    .status.ok{color:#bff7d1;}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Kalkulator – Studio Raz Druku Dwa</h1>
      <p class="small">Oblicz → Dodaj do listy → Wyślij listę do arkusza.</p>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="simple">Druk A4/A3</button>
        <button class="tab" data-tab="cad">Druk CAD</button>
        <button class="tab" data-tab="cad_ops">CAD: składanie / skan</button>
        <button class="tab" data-tab="biz">Wizytówki</button>
      </div>

      <!-- TAB: SIMPLE -->
      <section id="tab-simple">
        <h2>Druk A4/A3 + skan</h2>

        <div class="form">
          <div class="row">
            <label>Tryb</label>
            <div class="control">
              <div class="seg" id="simpleModeSeg">
                <button type="button" class="chip active" data-value="bw">Czarno-biały</button>
                <button type="button" class="chip" data-value="color">Kolorowy</button>
              </div>
            </div>
          </div>

          <div class="row">
            <label>Format</label>
            <div class="control">
              <div class="seg" id="simpleFormatSeg">
                <button type="button" class="chip active" data-value="A4">A4</button>
                <button type="button" class="chip" data-value="A3">A3</button>
              </div>
            </div>
          </div>

          <div class="row">
            <label>Ilość stron druku</label>
            <div class="control">
              <input id="pagesPrint" type="number" min="0" step="1" value="" placeholder="np. 25" />
            </div>
          </div>

          <div class="row">
            <label>Wysyłka e-mail</label>
            <div class="control">
              <label class="hint" style="display:flex; align-items:center; gap:8px; color:var(--txt); font-weight:800;">
                <input id="emailShip" type="checkbox" style="width:auto;">
                +1 zł (osobny produkt)
              </label>
            </div>
          </div>

          <div class="row">
            <label>Zadruk &gt; 25%</label>
            <div class="control">
              <label class="hint" style="display:flex; align-items:center; gap:8px; color:var(--txt); font-weight:800;">
                <input id="ink25" type="checkbox" style="width:auto;">
                Dodaj dopłatę +50% jako osobny produkt
              </label>

              <div id="ink25Box" style="margin-top:8px; display:none;">
                <div class="hint">Ilość stron z dopłatą +50% (niezależnie od ilości stron druku).</div>
                <input id="ink25Qty" type="number" min="0" step="1" value="" placeholder="np. 10" />
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <label>Skanowanie (A4/A3)</label>
            <div class="control">
              <select id="scanType">
                <option value="none">Brak</option>
                <option value="auto">Automatyczne A4/A3</option>
                <option value="manual">Ręczne z szyby A4/A3</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label>Ilość stron skanu</label>
            <div class="control">
              <input id="scanQty" type="number" min="0" step="1" value="" placeholder="np. 5" />
              <div class="hint">Liczone jako stawka za stronę wg progów.</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="calcBtnSimple" class="primary">Oblicz</button>
          <button id="addBtnSimple">Dodaj</button>
        </div>
      </section>

      <!-- TAB: CAD -->
      <section id="tab-cad" class="hidden">
        <h2>Druk CAD wielkoformatowy</h2>

        <div class="form">
          <div class="row">
            <label>Tryb</label>
            <div class="control">
              <div class="seg" id="cadModeSeg">
                <button type="button" class="chip active" data-value="bw">Czarno-biały</button>
                <button type="button" class="chip" data-value="color">Kolorowy</button>
              </div>
              <div class="hint">Jeśli długość = bazowa → formatowe (zł/szt); jeśli inna → MB (zł/mb).</div>
            </div>
          </div>

          <div class="row">
            <label>Format</label>
            <div class="control">
              <div class="seg" id="cadFormatSeg">
               <button type="button" class="chip active" data-value="A0p">A0+</button>
<button type="button" class="chip" data-value="A0">A0</button>
<button type="button" class="chip" data-value="A1">A1</button>
<button type="button" class="chip" data-value="A2">A2</button>
<button type="button" class="chip" data-value="A3">A3</button>

              </div>
              <div class="hint" id="cadBaseSize">Wymiar bazowy: —</div>
            </div>
          </div>

          <div class="row">
            <label>Długość (mm)</label>
            <div class="control">
              <input id="cadLengthMm" type="number" min="0" step="1" value="" placeholder="np. 594 albo 687" />
              <div class="hint">Liczymy po długości (dłuższy bok).</div>
            </div>
          </div>

          <div class="row">
            <label></label>
            <div class="control actions" style="margin:0;">
              <button id="cadUseBaseBtn" type="button">Użyj długości bazowej</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="hint" id="cadExplain"></div>

        <div class="actions">
          <button id="calcBtnCad" class="primary">Oblicz</button>
          <button id="addBtnCad">Dodaj</button>
        </div>
      </section>

      <!-- TAB: CAD OPS -->
      <section id="tab-cad_ops" class="hidden">
        <h2>CAD: składanie</h2>

        <div class="form">
          <div class="row">
            <label>Format</label>
            <div class="control">
              <div class="seg" id="foldFormatSeg">
                <button type="button" class="chip active" data-value="A0p">A0+</button>
                <button type="button" class="chip" data-value="A0">A0</button>
                <button type="button" class="chip" data-value="A1">A1</button>
                <button type="button" class="chip" data-value="A2">A2</button>
                <button type="button" class="chip" data-value="A3">A3</button>
                <button type="button" class="chip" data-value="A3L">A3-poprzeczne</button>
              </div>
              <div class="hint">Stawki: A0+ 4.00, A0 3.00, A1 2.00, A2 1.50, A3 1.00, A3-poprzeczne 0.70.</div>
            </div>
          </div>

          <div class="row">
            <label>Ilość sztuk</label>
            <div class="control">
              <input id="foldQty" type="number" min="0" step="1" value="" placeholder="np. 3" />
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="addBtnFold" class="success">Dodaj składanie</button>
        </div>

        <div class="divider"></div>

        <h2>Skanowanie wielkoformatowe</h2>
        <div class="form">
          <div class="row">
            <label>Długość (mm)</label>
            <div class="control">
              <input id="wfScanMm" type="number" min="0" step="1" value="" placeholder="np. 1100" />
              <div class="hint">0,08 zł / cm. mm → cm = mm / 10 (zaokrąglenie do pełnych cm).</div>
            </div>
          </div>
          <div class="row">
            <label>Ilość sztuk</label>
            <div class="control">
              <input id="wfScanQty" type="number" min="0" step="1" value="" placeholder="np. 2" />
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="addBtnWfScan" class="success">Dodaj skan</button>
        </div>
      </section>

      <!-- TAB: WIZYTÓWKI -->
      <section id="tab-biz" class="hidden">
        <h2>Wizytówki – druk cyfrowy</h2>

        <div class="form">
          <div class="row">
            <label>Rodzaj</label>
            <div class="control">
              <div class="seg" id="bizFamilySeg">
                <button type="button" class="chip active" data-value="standard">Standard</button>
                <button type="button" class="chip" data-value="deluxe">DELUXE</button>
              </div>
              <div class="hint">Standard: mat/błysk/softtouch (info ważne). DELUXE: UV 3D.</div>
            </div>
          </div>

          <div class="row" id="bizFinishRow">
            <label>Wykończenie</label>
            <div class="control">
              <div class="seg" id="bizFinishSeg">
                <button type="button" class="chip active" data-value="mat">Mat</button>
                <button type="button" class="chip" data-value="blysk">Błysk</button>
                <button type="button" class="chip" data-value="softtouch">SoftTouch</button>
              </div>
              <div class="hint">Ta opcja jest informacją do Excela (nawet jeśli ceny mat/błysk są takie same).</div>
            </div>
          </div>

          <div class="row" id="bizSizeRow">
            <label>Rozmiar</label>
            <div class="control">
              <div class="seg" id="bizSizeSeg">
                <button type="button" class="chip active" data-value="85x55">85×55</button>
                <button type="button" class="chip" data-value="90x50">90×50</button>
              </div>
            </div>
          </div>

          <div class="row" id="bizLamRow">
            <label>Foliowanie</label>
            <div class="control">
              <div class="seg" id="bizLamSeg">
                <button type="button" class="chip active" data-value="noLam">Bez</button>
                <button type="button" class="chip" data-value="lam">Foliowane</button>
              </div>
              <div class="hint">To wybiera „drugą cenę" z tabeli.</div>
            </div>
          </div>

          <div class="row" id="bizDeluxeOptRow" style="display:none;">
            <label>DELUXE opcja</label>
            <div class="control">
              <div class="seg" id="bizDeluxeOptSeg">
                <button type="button" class="chip active" data-value="uv3d_softtouch">UV 3D + SoftTouch</button>
                <button type="button" class="chip" data-value="uv3d_gold_softtouch">UV 3D + Złocenie + SoftTouch</button>
              </div>
              <div class="hint">Czas realizacji: 4–5 dni roboczych.</div>
            </div>
          </div>

          <div class="row">
            <label>Zadruk</label>
            <div class="control">
              <div class="seg" id="bizSidesSeg">
                <button type="button" class="chip active" data-value="s10">Jednostronne (1/0)</button>
                <button type="button" class="chip" data-value="s20">Dwustronne (2/0)</button>
              </div>
              <div class="hint">Nie wpływa na cenę (tu), ale idzie do Excela w podsumowaniu.</div>
            </div>
          </div>

          <div class="row">
            <label>Ilość sztuk</label>
            <div class="control">
              <input id="bizQty" type="number" min="1" step="1" value="" placeholder="np. 80 (zaokrągli do 100)" />
              <div class="hint">Zaokrąglamy w górę do najbliższego progu (np. 80 → 100).</div>
            </div>
          </div>

          <div class="actions">
            <button id="calcBtnBiz" class="primary">Oblicz</button>
            <button id="addBtnBiz">Dodaj</button>
          </div>
        </div>
      </section>

      <details style="margin-top:10px;">
        <summary>Szczegóły bieżącej pozycji (JSON)</summary>
        <pre id="debug">{}</pre>
      </details>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>Podsumowanie</h2>

      <div class="summary">
        <div class="sumRow">
          <div class="k">Ostatnio obliczone <span class="pill" id="currentHint"></span></div>
          <div class="v"><span id="currentPrice">0.00</span> zł</div>
        </div>
        <div class="sumRow total">
          <div class="k">Suma listy</div>
          <div class="v"><span id="basketTotal">0.00</span> zł</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="basket">
        <div class="basketList" id="basketList"></div>

        <div class="actions">
          <button id="clearBtn" class="danger">Wyczyść listę</button>
        </div>

        <div class="divider"></div>

        <details>
          <summary>Ustawienia wysyłki</summary>
          <div class="hint" style="margin-top:8px;">Wklej URL z wdrożenia Apps Script (Web App).</div>
          <input id="webAppUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec" />
        </details>

        <div class="actions">
          <button id="sendBtn" class="success">Wyślij listę do arkusza</button>
          <button id="copyBtn">Kopiuj JSON listy</button>
          <span id="sendStatus" class="status"></span>
        </div>

        <details style="margin-top:10px;">
          <summary>Szczegóły listy (JSON)</summary>
          <pre id="basketDebug">[]</pre>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
/* Helpers */
function money(n){ return (Math.round((Number(n)||0)*100)/100).toFixed(2); }
function numOrNull(v){
  const s = String(v ?? '').trim();
  if (!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function setStatus(msg, kind=''){
  const el=document.getElementById('sendStatus');
  el.className='status' + (kind ? ' '+kind : '');
  el.textContent=msg||'';
}
function setEl(id, text){ document.getElementById(id).textContent = text; }

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[m]));
}

function getSegValue(segId){
  return document.querySelector(`#${segId} .chip.active`)?.dataset?.value || null;
}
function activateChip(segId, value){
  document.querySelectorAll(`#${segId} .chip`).forEach(b=>{
    b.classList.toggle('active', b.dataset.value === value);
  });
}

/* Tabs */
let activeTab = 'simple';
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeTab = btn.dataset.tab;

    document.getElementById('tab-simple').classList.toggle('hidden', activeTab!=='simple');
    document.getElementById('tab-cad').classList.toggle('hidden', activeTab!=='cad');
    document.getElementById('tab-cad_ops').classList.toggle('hidden', activeTab!=='cad_ops');
    document.getElementById('tab-biz').classList.toggle('hidden', activeTab!=='biz');

    setStatus('');
    try{ calcCurrent(); } catch(e){}
  });
});

/* A4/A3 pricing */
const PRICE = {
  print: {
    bw: {
      A4: [
        {from: 1, to: 5,   unit: 0.90},
        {from: 6, to: 20,  unit: 0.60},
        {from: 21, to: 100, unit: 0.35},
        {from: 101, to: 500, unit: 0.30},
        {from: 500, to: 999, unit: 0.23},
        {from: 1000, to: 4989, unit: 0.19},
        {from: 1000, to: 9999, unit: 0.15}
      ],
      A3: [
        {from: 1, to: 5,   unit: 1.70},
        {from: 6, to: 20,  unit: 1.10},
        {from: 21, to: 100, unit: 0.70},
        {from: 101, to: 500, unit: 0.60},
        {from: 500, to: 999, unit: 0.45},
        {from: 1000, to: 4989, unit: 0.33}
      ]
    },
    color: {
      A4: [
        {from: 1, to: 10,  unit: 2.40},
        {from: 11, to: 40, unit: 2.20},
        {from: 41, to: 100, unit: 2.00},
        {from: 101, to: 250, unit: 1.80},
        {from: 251, to: 500, unit: 1.60},
        {from: 501, to: 999, unit: 1.40},
        {from: 1000, to: 4989, unit: 1.10}
      ],
      A3: [
        {from: 1, to: 10,  unit: 4.80},
        {from: 11, to: 40, unit: 4.20},
        {from: 41, to: 100, unit: 3.80},
        {from: 101, to: 250, unit: 3.00},
        {from: 251, to: 500, unit: 2.50},
        {from: 501, to: 999, unit: 1.90}
      ]
    }
  },
  scan: {
    auto: [
      {from: 1, to: 9, unit: 1.00},
      {from: 10, to: 49, unit: 0.50},
      {from: 50, to: 99, unit: 0.40},
      {from: 100, to: 999999999, unit: 0.25}
    ],
    manual: [
      {from: 1, to: 4, unit: 2.00},
      {from: 5, to: 999999999, unit: 1.00}
    ]
  },
  email_price: 1.00
};
function pickTier(tiers, qty){
  return tiers.find(t => qty >= t.from && qty <= t.to) || null;
}

/* CAD pricing */
const CAD_PRICE = {
  color: {
    formatowe: { A0p: 26.00, A0: 24.00, A1: 12.00, A2: 8.50, A3: 5.30 },
    mb:       { A0p: 21.00, A0: 20.00, A1: 14.50, A2: 13.90, A3: 12.00, R1067: 30.00 }
  },
  bw: {
    formatowe: { A0p: 12.50, A0: 11.00, A1: 6.00, A2: 4.00, A3: 2.50 },
    mb:       { A0p: 10.00, A0:  9.00, A1: 5.00, A2: 4.50, A3: 3.50, R1067: 12.50 }
  }
};
const CAD_BASE = {
  A0p: { w: 914, l: 1292, label: 'A0+' },
  A0:  { w: 841, l: 1189, label: 'A0'  },
  A1:  { w: 594, l: 841,  label: 'A1'  },
  A2:  { w: 420, l: 594,  label: 'A2'  },
  A3:  { w: 297, l: 420,  label: 'A3'  }
};
const FORMAT_TOLERANCE_MM = 0.5;

/* CAD ops */
const FOLD_PRICE = { A0p: 4.00, A0: 3.00, A1: 2.00, A2: 1.50, A3: 1.00, A3L: 0.70 };
const WF_SCAN_PRICE_PER_CM = 0.08;

/* =========================
   WIZYTÓWKI — BACKEND
========================= */
const BIZ = {
  cyfrowe: {
    standardPrices: {
      "85x55": {
        noLam: {50:65, 100:75, 150:85, 200:96, 250:110, 300:126, 400:146, 500:170, 1000:290},
        lam:   {50:160,100:170,150:180,200:190,250:200,300:220,400:240,500:250,1000:335}
      },
      "90x50": {
        noLam: {50:70, 100:79, 150:89, 200:99, 250:120, 300:129, 400:149, 500:175, 1000:300},
        lam:   {50:170,100:180,150:190,200:200,250:210,300:230,400:250,500:260,1000:345}
      }
    },
    softtouchPrices: {
      "85x55": {
        noLam: {50:65, 100:75, 150:85, 200:96, 250:110, 300:126, 400:145, 500:170, 1000:290},
        lam:   {50:170,100:190,150:210,200:220,250:230,300:240,400:260,500:270,1000:380}
      },
      "90x50": {
        noLam: {50:70, 100:79, 150:89, 200:99, 250:120, 300:129, 400:149, 500:175, 1000:300},
        lam:   {50:170,100:190,150:210,200:220,250:230,300:240,400:260,500:270,1000:390}
      }
    },
    deluxe: {
      leadTime: "4–5 dni roboczych",
      options: {
        uv3d_softtouch: {
          label: "Maker UV 3D + folia SOFTTOUCH",
          prices: {50:280, 100:320, 200:395, 250:479, 400:655, 500:778}
        },
        uv3d_gold_softtouch: {
          label: "Maker UV 3D + złocenie + folia SOFTTOUCH",
          prices: {50:450, 100:550, 200:650, 250:720, 400:850, 500:905}
        }
      }
    }
  }
};

function pickNearestCeilKey(table, qty){
  const keys = Object.keys(table || {}).map(Number).filter(Number.isFinite).sort((a,b)=>a-b);
  if (!keys.length) return null;
  const k = keys.find(x => qty <= x);
  return (k == null) ? null : k;
}
function bizSidesValue(){
  const sides = getSegValue('bizSidesSeg');
  return (sides === 's20') ? '2/0' : '1/0';
}
function bizFinishLabel(finish){
  if (finish === 'mat') return 'Mat';
  if (finish === 'blysk') return 'Błysk';
  if (finish === 'softtouch') return 'SoftTouch';
  return finish;
}
function getBizStandardTable(){
  const finish = getSegValue('bizFinishSeg');
  const size = getSegValue('bizSizeSeg');
  const lam = getSegValue('bizLamSeg');

  if (!finish) throw new Error('Wybierz wykończenie (mat/błysk/softtouch).');
  if (!size) throw new Error('Wybierz rozmiar.');
  if (!lam) throw new Error('Wybierz foliowanie.');

  const tablesByFinish = (finish === 'softtouch')
    ? BIZ.cyfrowe.softtouchPrices
    : BIZ.cyfrowe.standardPrices;

  const table = tablesByFinish?.[size]?.[lam];
  if (!table) throw new Error('Brak tabeli cen dla wybranej konfiguracji.');

  return { finish, size, lam, table };
}
function calcBizStandard(){
  const qtyIn = numOrNull(document.getElementById('bizQty').value);
  if (!qtyIn || qtyIn <= 0) throw new Error('Podaj ilość sztuk.');

  const { finish, size, lam, table } = getBizStandardTable();
  const qtyBilled = pickNearestCeilKey(table, qtyIn);
  if (qtyBilled == null) throw new Error('Brak progu cenowego dla takiej ilości (za duża ilość).');

  document.getElementById('bizQty').value = qtyBilled;
  const total = table[qtyBilled];

  const lamLabel = (lam === 'lam') ? 'foliowane' : 'bez foliowania';
  const sidesVal = bizSidesValue();
  const finishLabel = bizFinishLabel(finish);

  const label = `Wizytówki ${size} — ${finishLabel}`;
  const meta = `${qtyBilled} szt. (wpisano: ${qtyIn}), ${lamLabel}, zadruk: ${sidesVal}`;

  const payload = {
    createdAt: new Date().toISOString(),
    productCategory: 'businesscards',
    family: 'standard',
    finish,
    finishLabel,
    size,
    lamination: lamLabel,
    printSides: sidesVal,
    qtyRequested: qtyIn,
    qtyBilled,
    total: Number(money(total))
  };

  return { label, meta, total, hint: label, payload };
}
function calcBizDeluxe(){
  const opt = getSegValue('bizDeluxeOptSeg');
  const qtyIn = numOrNull(document.getElementById('bizQty').value);

  if (!opt) throw new Error('Wybierz wariant DELUXE.');
  if (!qtyIn || qtyIn <= 0) throw new Error('Podaj ilość sztuk.');

  const optObj = BIZ.cyfrowe.deluxe.options?.[opt];
  const table = optObj?.prices;
  if (!table) throw new Error('Brak tabeli cen DELUXE dla tej opcji.');

  const qtyBilled = pickNearestCeilKey(table, qtyIn);
  if (qtyBilled == null) throw new Error('Brak progu cenowego dla takiej ilości (za duża ilość).');

  document.getElementById('bizQty').value = qtyBilled;

  const total = table[qtyBilled];
  const sidesVal = bizSidesValue();

  const label = `Wizytówki DELUXE — ${optObj.label}`;
  const meta = `${qtyBilled} szt. (wpisano: ${qtyIn}), zadruk: ${sidesVal}, czas: ${BIZ.cyfrowe.deluxe.leadTime}`;

  const payload = {
    createdAt: new Date().toISOString(),
    productCategory: 'businesscards',
    family: 'deluxe',
    option: opt,
    optionLabel: optObj.label,
    leadTime: BIZ.cyfrowe.deluxe.leadTime,
    printSides: sidesVal,
    qtyRequested: qtyIn,
    qtyBilled,
    total: Number(money(total))
  };

  return { label, meta, total, hint: label, payload };
}
function calcBusinessCards(){
  const family = getSegValue('bizFamilySeg') || 'standard';
  return (family === 'deluxe') ? calcBizDeluxe() : calcBizStandard();
}
function syncBizUI(){
  const family = getSegValue('bizFamilySeg') || 'standard';
  const isDeluxe = (family === 'deluxe');

  document.getElementById('bizFinishRow').style.display = isDeluxe ? 'none' : '';
  document.getElementById('bizSizeRow').style.display = isDeluxe ? 'none' : '';
  document.getElementById('bizLamRow').style.display = isDeluxe ? 'none' : '';
  document.getElementById('bizDeluxeOptRow').style.display = isDeluxe ? '' : 'none';
}

/* Chip events */
document.getElementById('simpleModeSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('simpleModeSeg', btn.dataset.value);
});
document.getElementById('simpleFormatSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('simpleFormatSeg', btn.dataset.value);
});
document.getElementById('cadModeSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('cadModeSeg', btn.dataset.value);
  syncCadBaseInfo();
});
document.getElementById('cadFormatSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('cadFormatSeg', btn.dataset.value);
  syncCadBaseInfo();
});
document.getElementById('foldFormatSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('foldFormatSeg', btn.dataset.value);
});

/* Wizytówki chipy */
document.getElementById('bizFamilySeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('bizFamilySeg', btn.dataset.value);
  syncBizUI();
});
document.getElementById('bizFinishSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('bizFinishSeg', btn.dataset.value);
});
document.getElementById('bizSizeSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('bizSizeSeg', btn.dataset.value);
});
document.getElementById('bizLamSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('bizLamSeg', btn.dataset.value);
});
document.getElementById('bizDeluxeOptSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('bizDeluxeOptSeg', btn.dataset.value);
});
document.getElementById('bizSidesSeg').addEventListener('click', (e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  activateChip('bizSidesSeg', btn.dataset.value);
});

/* Ink UI */
function syncInkUI(){
  const ink25 = document.getElementById('ink25').checked;
  document.getElementById('ink25Box').style.display = ink25 ? 'block' : 'none';
  if (!ink25) document.getElementById('ink25Qty').value = '';
}
document.getElementById('ink25').addEventListener('input', syncInkUI);
syncInkUI();

/* CAD base info */
function syncCadBaseInfo(){
  const fmt = getSegValue('cadFormatSeg') || 'A0';
  const b = CAD_BASE[fmt];
  document.getElementById('cadBaseSize').textContent = `Wymiar bazowy: ${b.w}×${b.l} mm`;
  document.getElementById('cadExplain').textContent = `Liczymy po długości: ${b.l} mm (dłuższy bok).`;
}
document.getElementById('cadUseBaseBtn').addEventListener('click', ()=>{
  const fmt = getSegValue('cadFormatSeg') || 'A0';
  document.getElementById('cadLengthMm').value = CAD_BASE[fmt].l;
});
syncCadBaseInfo();

/* Basket */
let basket = [];
function basketSum(){ return basket.reduce((s,it)=> s + (Number(it.total)||0), 0); }

function renderBasket(){
  const list = document.getElementById('basketList');
  list.innerHTML = '';

  if (basket.length === 0) {
    list.innerHTML = `<div class="basketItem"><div><div class="basketTitle">Brak pozycji</div><div class="basketMeta">Kliknij „Dodaj", aby zbudować listę.</div></div><div class="basketPrice">—</div></div>`;
  } else {
    basket.forEach((item, idx)=>{
      const row = document.createElement('div');
      row.className = 'basketItem';
      row.innerHTML = `
        <div style="min-width:0;">
          <div class="basketTitle">${escapeHtml(item.label || 'Pozycja')}</div>
          <div class="basketMeta">${escapeHtml(item.meta || '')}</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="basketPrice">${money(item.total)} zł</div>
          <button class="iconBtn" data-remove="${idx}" title="Usuń">×</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  setEl('basketTotal', money(basketSum()));
  document.getElementById('basketDebug').textContent = JSON.stringify(basket.map(b=>b.payload), null, 2);
}
document.getElementById('basketList').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-remove]');
  if (!btn) return;
  const idx = Number(btn.dataset.remove);
  basket.splice(idx, 1);
  renderBasket();
});

function setCurrent(res){
  setEl('currentPrice', money(res.total));
  document.getElementById('currentHint').textContent = (res.hint || res.label) ? `(${res.hint || res.label})` : '';
  document.getElementById('debug').textContent = JSON.stringify(res.payload, null, 2);
}

/* Calculators */
function calcSimpleMainOnly(){
  const mode = getSegValue('simpleModeSeg');
  const format = getSegValue('simpleFormatSeg');
  const pages = numOrNull(document.getElementById('pagesPrint').value);
  if (pages === null || pages <= 0) throw new Error('Podaj ilość stron druku.');

  const printTier = pickTier(PRICE.print[mode][format], pages);
  if (!printTier) throw new Error('Brak progu cenowego dla druku.');

  const unitPrint = printTier.unit;
  const total = pages * unitPrint;

  const label = `Druk ${format} ${mode === 'bw' ? 'CZ-B' : 'KOLOR'}`;
  const meta  = `${pages} str. • ${money(unitPrint)} zł/str.`;
  const payload = {
    createdAt: new Date().toISOString(),
    productCategory: 'simple_print',
    mode, format, pages,
    unitPrint,
    total: Number(money(total))
  };
  return { label, meta, total, hint: label, payload };
}

function calcEmailItem(){
  const on = document.getElementById('emailShip').checked;
  if (!on) return null;
  const total = PRICE.email_price;
  const label = 'Wysyłka e-mail';
  const payload = { createdAt: new Date().toISOString(), productCategory: 'email', total: Number(money(total)) };
  return { label, meta: '+1 zł', total, hint: label, payload };
}

function calcInkItem(unitPrint){
  const on = document.getElementById('ink25').checked;
  if (!on) return null;

  const qty = numOrNull(document.getElementById('ink25Qty').value);
  if (qty === null || qty <= 0) throw new Error('Podaj ilość stron dla dopłaty zadruku.');

  const total = 0.5 * unitPrint * qty;
  const label = 'Dopłata: zadruk > 25% (+50%)';
  const meta = `${qty} × (0.5 × stawka strony)`;
  const payload = {
    createdAt: new Date().toISOString(),
    productCategory: 'ink_over_25',
    pagesWithExtra: qty,
    baseUnitPrint: Number(money(unitPrint)),
    total: Number(money(total))
  };
  return { label, meta, total, hint: label, payload };
}

function calcScanA4A3Item(){
  const scanType = document.getElementById('scanType').value;
  if (scanType === 'none') return null;

  const qty = numOrNull(document.getElementById('scanQty').value);
  if (qty === null || qty <= 0) throw new Error('Podaj ilość stron skanu.');

  const scanTier = pickTier(PRICE.scan[scanType], qty);
  if (!scanTier) throw new Error('Brak progu cenowego dla skanowania.');

  const total = qty * scanTier.unit;
  const label = `Skanowanie (${scanType})`;
  const meta = `${qty} str. • ${money(scanTier.unit)} zł/str.`;
  const payload = {
    createdAt: new Date().toISOString(),
    productCategory: 'scan_a4a3',
    scanType, qty,
    unit: Number(money(scanTier.unit)),
    total: Number(money(total))
  };
  return { label, meta, total, hint: label, payload };
}

function calcSimpleBundlePreview(){
  const main = calcSimpleMainOnly();
  const items = [main];
  const emailItem = calcEmailItem(); if (emailItem) items.push(emailItem);
  const inkItem = calcInkItem(main.payload.unitPrint); if (inkItem) items.push(inkItem);
  const scanItem = calcScanA4A3Item(); if (scanItem) items.push(scanItem);

  const total = items.reduce((s,i)=>s+i.total, 0);
  return {
    label: 'Pakiet A4/A3',
    meta: items.map(i=>i.label).join(' + '),
    total,
    hint: `Suma pozycji: ${items.length}`,
    payload: { createdAt: new Date().toISOString(), productCategory: 'simple_bundle_preview', items: items.map(i=>i.payload), total: Number(money(total)) },
    items
  };
}

/* CAD */
function calcCad(){
  const mode = getSegValue('cadModeSeg');
  const fmt  = getSegValue('cadFormatSeg');

  const lenMm = document.getElementById('cadLengthMm').valueAsNumber;
  if (!Number.isFinite(lenMm) || lenMm <= 0) throw new Error('Podaj długość (mm).');

  const base = CAD_BASE[fmt];
  if (!base) throw new Error('Nieznany format CAD.');

  const isFormatowe = Math.abs(lenMm - base.l) <= FORMAT_TOLERANCE_MM;
  const detectedType = isFormatowe ? 'formatowe' : 'mb';

  const rate = CAD_PRICE[mode]?.[detectedType]?.[fmt];
  if (rate == null) throw new Error('Brak stawki w cenniku dla CAD.');

  const meters = lenMm / 1000;

  let total, meta;
  if (detectedType === 'formatowe') {
    total = rate;
    meta = `FORMATOWE • ${base.w}×${base.l} mm • ${money(rate)} zł/szt.`;
  } else {
    total = meters * rate;
    meta = `MB • ${lenMm} mm (${money(meters)} m) • ${money(rate)} zł/mb`;
  }

  const label = `CAD ${mode === 'bw' ? 'CZ-B' : 'KOLOR'} ${base.label}`;
  const payload = {
    createdAt: new Date().toISOString(),
    productCategory: 'cad_auto',
    cadMode: mode,
    cadFormat: fmt,
    lengthMm: lenMm,
    meters: Number(money(meters)),
    detectedType,
    rate: Number(money(rate)),
    total: Number(money(total))
  };
  return { label, meta, total, hint: label, payload };
}

function calcFoldItem(){
  const fmt = getSegValue('foldFormatSeg');
  const qty = numOrNull(document.getElementById('foldQty').value);
  if (qty === null || qty <= 0) throw new Error('Podaj ilość sztuk składania.');

  const unit = FOLD_PRICE[fmt];
  if (unit == null) throw new Error('Brak stawki składania w backendzie.');

  const total = qty * unit;
  const labelFmt = (fmt === 'A0p') ? 'A0+' : (fmt === 'A3L' ? 'A3-poprzeczne' : fmt);
  const label = `Składanie (${labelFmt})`;
  const meta = `${qty} szt. • ${money(unit)} zł/szt.`;
  const payload = { createdAt: new Date().toISOString(), productCategory: 'cad_folding', foldFormat: fmt, qty, unit: Number(money(unit)), total: Number(money(total)) };
  return { label, meta, total, hint: label, payload };
}

function calcWfScanItem(){
  const mm = numOrNull(document.getElementById('wfScanMm').value);
  const qty = numOrNull(document.getElementById('wfScanQty').value);
  if (mm === null || mm <= 0) throw new Error('Podaj długość (mm) dla skanu.');
  if (qty === null || qty <= 0) throw new Error('Podaj ilość sztuk skanu.');

  const cmRounded = Math.round(mm / 10);
  const unitPrice = cmRounded * WF_SCAN_PRICE_PER_CM;
  const total = qty * unitPrice;

  const label = 'Skanowanie wielkoformatowe';
  const meta = `${qty} szt. • ${mm} mm → ${cmRounded} cm • 0,08 zł/cm`;
  const payload = { createdAt: new Date().toISOString(), productCategory: 'wf_scan_cm', lengthMm: mm, lengthCmRounded: cmRounded, qty, pricePerCm: WF_SCAN_PRICE_PER_CM, unitPrice: Number(money(unitPrice)), total: Number(money(total)) };
  return { label, meta, total, hint: label, payload };
}

/* Current */
function calcCurrent(){
  setStatus('');
  let res;
  if (activeTab === 'simple') res = calcSimpleBundlePreview();
  else if (activeTab === 'cad') res = calcCad();
  else if (activeTab === 'biz') res = calcBusinessCards();
  else res = { label:'CAD operacje', meta:'Użyj przycisków Dodaj', total:0, hint:'CAD operacje', payload:{ productCategory:'cad_ops', total:0 } };
  setCurrent(res);
  return res;
}

/* Add */
function addItem(item){
  basket.push({ label: item.label, meta: item.meta, total: Number(money(item.total)), payload: item.payload });
  renderBasket();
}
function addSimpleToBasket(){
  const main = calcSimpleMainOnly();
  addItem(main);
  const emailItem = calcEmailItem(); if (emailItem) addItem(emailItem);
  const inkItem = calcInkItem(main.payload.unitPrint); if (inkItem) addItem(inkItem);
  const scanItem = calcScanA4A3Item(); if (scanItem) addItem(scanItem);

  const total = [main,emailItem,inkItem,scanItem].filter(Boolean).reduce((s,i)=>s+i.total,0);
  setEl('currentPrice', money(total));
  document.getElementById('currentHint').textContent = '(Dodano pozycje A4/A3)';
}

/* Buttons */
document.getElementById('calcBtnSimple').addEventListener('click', ()=>{ try{ setCurrent(calcSimpleBundlePreview()); } catch(e){ setStatus(e.message || String(e), 'err'); } });
document.getElementById('addBtnSimple').addEventListener('click', ()=>{ try{ addSimpleToBasket(); setStatus('Dodano do listy.', 'ok'); } catch(e){ setStatus(e.message || String(e), 'err'); } });

document.getElementById('calcBtnCad').addEventListener('click', ()=>{ try{ setCurrent(calcCad()); } catch(e){ setStatus(e.message || String(e), 'err'); } });
document.getElementById('addBtnCad').addEventListener('click', ()=>{ try{ const item=calcCad(); addItem(item); setCurrent(item); setStatus('Dodano do listy.', 'ok'); } catch(e){ setStatus(e.message || String(e), 'err'); } });

document.getElementById('addBtnFold').addEventListener('click', ()=>{ try{ const item=calcFoldItem(); addItem(item); setCurrent(item); setStatus('Dodano składanie.', 'ok'); } catch(e){ setStatus(e.message || String(e), 'err'); } });
document.getElementById('addBtnWfScan').addEventListener('click', ()=>{ try{ const item=calcWfScanItem(); addItem(item); setCurrent(item); setStatus('Dodano skan.', 'ok'); } catch(e){ setStatus(e.message || String(e), 'err'); } });

document.getElementById('calcBtnBiz').addEventListener('click', ()=>{ try{ setCurrent(calcBusinessCards()); } catch(e){ setStatus(e.message || String(e), 'err'); } });
document.getElementById('addBtnBiz').addEventListener('click', ()=>{ try{ const item=calcBusinessCards(); addItem(item); setCurrent(item); setStatus('Dodano do listy.', 'ok'); } catch(e){ setStatus(e.message || String(e), 'err'); } });

document.getElementById('clearBtn').addEventListener('click', ()=>{
  basket=[];
  renderBasket();
  setEl('currentPrice','0.00');
  document.getElementById('currentHint').textContent='';
  document.getElementById('debug').textContent='{}';
  setStatus('Wyczyszczono listę.', 'ok');
});

document.getElementById('copyBtn').addEventListener('click', async ()=>{
  try{
    const payload = { createdAt: new Date().toISOString(), productCategory:'basket', items: basket.map(b=>b.payload), total: Number(money(basketSum())) };
    await navigator.clipboard.writeText(JSON.stringify(payload));
    setStatus('Skopiowano JSON listy.', 'ok');
  } catch(e){ setStatus(e.message || String(e), 'err'); }
});

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  setStatus('');
  const url = (document.getElementById('webAppUrl').value || '').trim();
  if (!url) { setStatus('Wklej WEB APP URL w „Ustawienia wysyłki".', 'err'); return; }
  if (basket.length === 0) { setStatus('Lista jest pusta.', 'err'); return; }

  const body = { createdAt: new Date().toISOString(), productCategory:'basket', items: basket.map(b=>b.payload), total: Number(money(basketSum())) };

  setStatus('Wysyłam...');
  try{
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    setStatus('Wysłano: ' + txt, 'ok');
  } catch(e){
    setStatus('Błąd wysyłki: ' + (e.message || String(e)), 'err');
  }
});

// start
try{
  renderBasket();
  calcCurrent();
  syncBizUI();
} catch(e){}
</script>
</body>
</html>